from fastapi_django.utils.logging import logging_context

# Логирование

Логирование реализовано как в Django. Настройки логирования прописываются в LOGGING. Значение может быть словарем
или callable.
Желательно, чтобы настройка LOGGING была единым местом для определения настроек логирования - так, например,
при запуске uvicorn в команде [runserver](../fastapi_django/management/cli.py) в функцию `run()` в параметр log_config 
передается None, чтобы дефолтные настройки, которые uvicorn хранит в константе uvicorn.config.LOGGING_CONFIG 
не перетирали настройки из LOGGING:

```python
import uvicorn

uvicorn.run(**params, log_config=None)
```

## Контекстно зависимое логирование

Чтобы добавить в лог дополнительных полей, используйте контекстный менеджер `fastapi_django.utils.logging.logging_context`.
Пример применения:

```python
import logging
from fastapi_django.utils.logging import logging_context


with logging_context(num=1):
    logging.info("лог с контекстом")
    # выведет сообщение
    # {
    #     "message": "лог с контекстом",
    #     "num": 1
    # }
logging.info("лог БЕЗ контекста")
# выведет сообщение:
# {
#     "message": "лог с контекстом"
# }
```

## Обновление контекста логирования

Иногда необходимо добавить в контекст логирования, но нет возможности применить контекстный менеджер. Например, 
при успешной аутентификации необходимо добавить информацию о пользователе (логин, идентификатор), но использования 
контекстного менеджера вот так:

```python
from fastapi.security import HTTPBearer
from fastapi import Request
from fastapi_django.utils.logging import logging_context


class UsrAdmAuth(HTTPBearer):

    async def __call__(self, request: Request):
        # аутентификация...
        user = self._get_user()
        with logging_context(username=user.username):
            return user

    async def _get_user(self) -> User:
        # получаем пользователя кз
```

не сработает. Поэтому предлагается использовать функцию `fastapi_django.utils.logging.update_logging_context`.
Перепишем код выше:

```python
from fastapi.security import HTTPBearer
from fastapi import Request
from fastapi_django.utils.logging import update_logging_context


class UsrAdmAuth(HTTPBearer):

    async def __call__(self, request: Request):
        # аутентификация...
        user = self._get_user()
        update_logging_context(username=user.username)
        return user

    async def _get_user(self) -> User:
        # получаем пользователя кз
```

тогда username появится в последующих логах.

## Пример

Пример настройки LOGGING см. по ссылке https://github.com/albertalexandrov/fastapi-django-example/blob/main/src/settings.py
